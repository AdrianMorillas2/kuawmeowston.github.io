<!DOCTYPE html>
<html>
	<head>
		<title>Katwaii</title>
		<link type="text/css" rel="stylesheet" href="css/style.css"/>
		<script type="text/javascript" src="https://code.jquery.com/jquery-latest.min.js"></script>
	</head>

	<body onload="PlayMusic()">
		<!--Canvas para el menu-->
		<canvas id="myCanvas" width="1200" height="600"><p>Your browser does not support HTML5!</p></canvas> 

		<script type="text/javascript">
			//variable que contiene la música de fondo
			var myMusic;
			//Crea la música y la reproduce
			function PlayMusic(){
				myMusic= new sound("sound/bg_music.mp3");
				myMusic.play();
			}

			//Clase que coge sonido y crea los objetos para que se reproduzca. 
			function sound(src) {
    			this.sound = document.createElement("audio");
				this.sound.src = src;
				this.sound.setAttribute("preload", "auto");
				this.sound.setAttribute("controls", "volume");
				this.sound.volume=0.1;
				this.sound.style.display = "none";
				document.body.appendChild(this.sound);
				this.play = function(){
					this.sound.play();
				}
				this.stop = function(){
					this.sound.pause();
				}  
				//Esta funcion cambia el volumen
				this.changeVolume= function(newVolume){
					this.sound.volume=newVolume;
				}  
			}

			var control = {up: 38, enter: 13, down:40};
			//Declarar el canvas, con sus variables
			var canvas = document.getElementById("myCanvas");
			var context = canvas.getContext("2d");
			var width = canvas.getAttribute('width');
			var height = canvas.getAttribute('height');
			// funciones de resize
			$(function(){
    				resizeCanvas();
			});
			$(window).on('resize', function(){
    				resizeCanvas();
			});
		
			//Variables para las imagenes
			var bgImage = new Image();
			var logoImage = new Image();
			var playImage = new Image();
			var instructImage = new Image();
			var settingsImage = new Image();
			var creditsImage = new Image();
			var shipImage = new Image();
			//Posiblemete borrable: Es para que el fondo se mueva hacia arriba 
			var backgroundY = 0;
			var speed = 1;
			//Posición de los botones del menu
			var buttonX = [540,460,500,510];
			var buttonY = [200,240,280,320];
			var buttonWidth = [96,260,182,160];
			var buttonHeight = [40,40,40,40];
			var mouseX = [541, 461, 507, 511];
			var mouseY = [201, 241, 281, 321];
			var mouse_index = 0;
			//variables para modificar la posición y rotación de la nave (en nuestro caso un gato i guess)
			var shipX = [0,0];
			var shipY = [0,0];
			var shipWidth = 35;
			var shipHeight = 40;
			var shipVisible = false;
			var shipSize = shipWidth;
			var shipRotate = 0;
			//variables para definir el funcionamiento de las animaciones del canvas
			var frames = 30;
		   	 var timerId = 0;
			var fadeId = 0;
			var time = 0.0;
			//Se asignan a las imagenes el archivo fuente. Por ahora no tocar hasta tener las definitivas. Si no funca en normal, porque son 
			//imagenes que puse de muestra
			shipImage.src = "images/ship.png";  
			bgImage.src = "images/Background_2.png";
			logoImage.src = "images/logo.png";
			playImage.src = "images/play.png";
			instructImage.src = "images/instructions.png";
			settingsImage.src = "images/settings.png";
			creditsImage.src = "images/credits.png"
			bgImage.onload = function(){
				context.drawImage(bgImage, 0, 0);
			};
			logoImage.onload = function(){
				context.drawImage(logoImage, 50, -10);
			}
			playImage.onload = function(){
				context.drawImage(playImage, buttonX[0], buttonY[0]);
			}
			instructImage.onload = function(){
				context.drawImage(instructImage, buttonX[1], buttonY[1]);
			}
			settingsImage.onload = function(){
				context.drawImage(settingsImage, buttonX[2], buttonY[2]);
			}
			creditsImage.onload = function(){
				context.drawImage(creditsImage, buttonX[3], buttonY[3]);
			}
			//intervalo de refresco del canvas
			timerId = setInterval("update()", 1000/frames);
			//metodos para controlar el raton
			/*
			canvas.addEventListener("mousemove", checkPos);
			canvas.addEventListener("mouseup", checkClick);
			*/
			//Actualiza los frames
			function update() {
				//PlayMusic();
				clear();
				move();
				draw();
				checkPos();
			}
			//Se usa para eliminar las imagenes si es necesario
			function clear() {
				context.clearRect(0, 0, width, height);
			}
			//Se usa para cambiar los valores de las variables de imagenes
			function move(){
				backgroundY -= speed;
				if(backgroundY == -1 * height){
					backgroundY = 0;
				}
				if(shipSize == shipWidth){
					shipRotate = -1;
				}
				if(shipSize == 0){
					shipRotate = 1;
				}
				shipSize += shipRotate;
			}
			//Coloca las imagenes en el canvas
			function draw(){
				context.drawImage(bgImage, 0, backgroundY);
				context.drawImage(logoImage, 400,-10);
				context.drawImage(playImage, buttonX[0], buttonY[0]);
				context.drawImage(instructImage, buttonX[1], buttonY[1]);
				context.drawImage(settingsImage, buttonX[2], buttonY[2]);
				context.drawImage(creditsImage, buttonX[3], buttonY[3]);
				if(shipVisible == true){
					draw_ship();
				}
			}
			
			//Comprueba la posicion del raton para saber como interactuar con el
			function checkPos(mouseEvent){
				for(i = 0; i < buttonX.length; i++){
					if(mouseX[mouse_index] > buttonX[i] && mouseX[mouse_index] < buttonX[i] + buttonWidth[i]){
						if(mouseY[mouse_index] > buttonY[i] && mouseY[mouse_index] < buttonY[i] + buttonHeight[i]){
							//console.log(mouseX[mouse_index] + " " + buttonX[i] + " " + mouseY[mouse_index] + " " + buttonY[i]);
							//console.log(mouseX[mouse_index] + " " + (buttonX[i] + buttonWidth[i]) + " " + mouseY[mouse_index] + " " + (buttonY[i] + buttonHeight[i]));
							shipVisible = true;
							console.log(mouse_index + " " + shipVisible);
							shipX[0] = buttonX[i] - (shipWidth/2) - 2;
							shipY[0] = buttonY[i] + 2;
							shipX[1] = buttonX[i] + buttonWidth[i] + (shipWidth/2); 
							shipY[1] = buttonY[i] + 2;
							//console.log(shipX[0] + " " + shipY[0] + " " + shipX[1] + " " + shipY[0]);
							draw_ship ();
						}
					}else{
						shipVisible = false;
					}
				}
			}
			
			//Comprueba los click del raton
			function checkClick(mouseEvent){
				for(i = 0; i < buttonX.length; i++){
					/*
					if(mouseX > buttonX[i] && mouseX < buttonX[i] + buttonWidth[i]){
						if(mouseY > buttonY[i] && mouseY < buttonY[i] + buttonHeight[i]){
							fadeId = setInterval("fadeOut()", 1000/frames);
							clearInterval(timerId);
							canvas.removeEventListener("mousemove", checkPos);
							canvas.removeEventListener("mouseup", checkClick);
						}
					}*/
					if(mouseX > buttonX[0] && mouseX < buttonX[0] + buttonWidth[0]){
						if(mouseY > buttonY[0] && mouseY < buttonY[0] + buttonHeight[0]){
							fadeId = setInterval("fadeOut()", 1000/frames);
							clearInterval(timerId);
							/*
							canvas.removeEventListener("mousemove", checkPos);
							canvas.removeEventListener("mouseup", checkClick);
							*/
							var Jugadores = 1;
							localStorage.setItem("jugadores", Jugadores);
							window.location.href = "juego.html";
						}
					}
					if(mouseX > buttonX[1] && mouseX < buttonX[1] + buttonWidth[1]){
						if(mouseY > buttonY[1] && mouseY < buttonY[1] + buttonHeight[1]){
							fadeId = setInterval("fadeOut()", 1000/frames);
							clearInterval(timerId);
							/*
							canvas.removeEventListener("mousemove", checkPos);
							canvas.removeEventListener("mouseup", checkClick);
							*/
							var Jugadores = 2;
							localStorage.setItem("jugadores", Jugadores);
							window.location.href = "juego.html";
						}
					}
				}
			}
			
			function draw_ship (){
				context.drawImage(shipImage, shipX[0] - (shipSize/2), shipY[0], shipSize, shipHeight);
				context.drawImage(shipImage, shipX[1] - (shipSize/2), shipY[1], shipSize, shipHeight);
			}
			//Pone la pantalla a negro cuando se clica en uno de los botones
			function fadeOut(){
				context.fillStyle = "rgba(0,0,0, 0.2)";
				context.fillRect (0, 0, width, height);
				time += 0.1;
				if(time >= 2){
					clearInterval(fadeId);
					time = 0;
					timerId = setInterval("update()", 1000/frames);
					/*
					canvas.addEventListener("mousemove", checkPos);
					canvas.addEventListener("mouseup", checkClick);
					*/
				}
			}
			function resizeCanvas() {
				var canvas = $('#myCanvas');
				canvas.css("width", $(window).width());
				canvas.css("height", $(window).height());
			}
			function sleep(ms) {
  				return new Promise(resolve => setTimeout(resolve, ms));
			}

			document.onkeydown = async function(e) {
				   e = e || window.event; 
				   if(e.keyCode == control.up){
					myMusic.changeVolume(1.0);//Test pa que veais que tira
					   if(mouse_index > 0){
						   mouse_index -= 1;
					   }
				   }
				   if(e.keyCode== 119){

				   }
				   if(e.keyCode == control.down){
						if(mouse_index < 3){
							mouse_index += 1;
						}
				   }
				   if(e.keyCode == control.enter){
						switch(mouse_index){
							case 0:
								fadeOut();
								await sleep(500);
								var Jugadores = 1;
								localStorage.setItem("jugadores", Jugadores);
								window.location.href = "juego.html";
								break;
							case 1:
								fadeOut();
								await sleep(500);
								var Jugadores = 2;
								localStorage.setItem("jugadores", Jugadores);
								window.location.href = "juego.html";
								break;
							case 2:
								fadeOut();
								break;
							case 3:
								fadeOut();
								break;
						}
				   }
			}
		</script> 
	</body>
</html> 
